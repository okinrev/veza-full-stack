global
    daemon
    user haproxy
    group haproxy
    log stdout local0

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option forwardfor
    option http-server-close
    
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

frontend veza_main
    bind *:80
    
    acl is_api path_beg /api
    acl is_chat_api path_beg /chat-api
    acl is_stream_api path_beg /stream
    acl is_websocket path_beg /ws
    acl is_websocket_upgrade hdr(Connection) -i upgrade
    acl is_websocket_upgrade hdr(Upgrade) -i websocket
    
    use_backend veza_websocket if is_websocket
    use_backend veza_websocket if is_websocket_upgrade
    use_backend veza_api if is_api
    use_backend veza_chat if is_chat_api
    use_backend veza_stream if is_stream_api
    default_backend veza_frontend

backend veza_frontend
    balance roundrobin
    server frontend1 10.5.191.41:3000

backend veza_api
    balance roundrobin
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-response set-header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    server api1 10.5.191.241:8080

backend veza_chat
    balance roundrobin
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-response set-header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    server chat1 10.5.191.49:3001

backend veza_stream
    balance roundrobin
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-response set-header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    server stream1 10.5.191.196:8000

backend veza_websocket
    balance source
    timeout server 3600s
    timeout tunnel 3600s
    server websocket1 10.5.191.241:8080
