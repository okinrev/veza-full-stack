#!/bin/bash

# üöÄ Script de d√©ploiement automatis√© - Veza Chat Server v0.2.0
# D√©ploiement production-ready avec v√©rifications de s√©curit√©

set -euo pipefail  # Arr√™t imm√©diat en cas d'erreur

# ================================================================
# CONFIGURATION
# ================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
BACKUP_DIR="$PROJECT_ROOT/backups"
LOG_FILE="$PROJECT_ROOT/deploy.log"

# Couleurs pour l'affichage
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ================================================================
# FONCTIONS UTILITAIRES
# ================================================================

log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $*" | tee -a "$LOG_FILE"
}

error() {
    echo -e "${RED}[ERROR]${NC} $*" | tee -a "$LOG_FILE" >&2
}

warning() {
    echo -e "${YELLOW}[WARNING]${NC} $*" | tee -a "$LOG_FILE"
}

info() {
    echo -e "${BLUE}[INFO]${NC} $*" | tee -a "$LOG_FILE"
}

check_requirements() {
    log "üîç V√©rification des pr√©requis..."
    
    # V√©rifier Rust
    if ! command -v cargo &> /dev/null; then
        error "Cargo/Rust non trouv√©. Installez Rust: https://rustup.rs/"
        exit 1
    fi
    
    # V√©rifier PostgreSQL
    if ! command -v psql &> /dev/null; then
        error "PostgreSQL client (psql) non trouv√©"
        exit 1
    fi
    
    # V√©rifier SQLx CLI
    if ! command -v sqlx &> /dev/null; then
        warning "SQLx CLI non trouv√©. Installation..."
        cargo install sqlx-cli --no-default-features --features postgres
    fi
    
    log "‚úÖ Pr√©requis OK"
}

create_backup() {
    log "üíæ Cr√©ation de la sauvegarde..."
    
    mkdir -p "$BACKUP_DIR"
    local backup_file="$BACKUP_DIR/backup_$(date +%Y%m%d_%H%M%S).sql"
    
    if [[ -n "${DATABASE_URL:-}" ]]; then
        pg_dump "$DATABASE_URL" > "$backup_file" 2>/dev/null || {
            warning "Impossible de cr√©er la sauvegarde (base vide ou inexistante)"
            return 0
        }
        log "‚úÖ Sauvegarde cr√©√©e: $backup_file"
    else
        warning "DATABASE_URL non d√©finie, sauvegarde ignor√©e"
    fi
}

setup_database() {
    log "üóÑÔ∏è  Configuration de la base de donn√©es..."
    
    if [[ -z "${DATABASE_URL:-}" ]]; then
        error "DATABASE_URL doit √™tre d√©finie"
        exit 1
    fi
    
    # Cr√©er la base si n√©cessaire
    info "Cr√©ation de la base de donn√©es si n√©cessaire..."
    sqlx database create --database-url "$DATABASE_URL" 2>/dev/null || true
    
    # Appliquer les migrations
    info "Application des migrations..."
    cd "$PROJECT_ROOT"
    sqlx migrate run --database-url "$DATABASE_URL"
    
    log "‚úÖ Base de donn√©es configur√©e"
}

build_application() {
    log "üî® Compilation de l'application..."
    
    cd "$PROJECT_ROOT"
    
    # Nettoyage
    cargo clean
    
    # Build optimis√© pour production
    RUSTFLAGS="-C target-cpu=native" cargo build --release
    
    # V√©rifier que le binaire existe
    if [[ ! -f "target/release/chat-server" ]]; then
        error "√âchec de compilation"
        exit 1
    fi
    
    log "‚úÖ Compilation termin√©e"
}

run_tests() {
    log "üß™ Ex√©cution des tests..."
    
    cd "$PROJECT_ROOT"
    
    # Tests unitaires
    info "Tests unitaires..."
    cargo test --release
    
    # Tests d'int√©gration si disponibles
    if cargo test --list | grep -q "integration"; then
        info "Tests d'int√©gration..."
        cargo test --release --test integration
    fi
    
    log "‚úÖ Tests pass√©s"
}

security_check() {
    log "üîí V√©rifications de s√©curit√©..."
    
    cd "$PROJECT_ROOT"
    
    # Audit des d√©pendances
    if command -v cargo-audit &> /dev/null; then
        info "Audit des vuln√©rabilit√©s..."
        cargo audit
    else
        warning "cargo-audit non install√©, audit ignor√©"
    fi
    
    # V√©rifier la configuration
    if [[ -f ".env" ]]; then
        if grep -q "your-super-secret" .env; then
            error "Secret JWT par d√©faut d√©tect√©! Changez CHAT_SERVER__SECURITY__JWT_SECRET"
            exit 1
        fi
        
        if grep -q "password@localhost" .env; then
            warning "Mot de passe par d√©faut d√©tect√© en production"
        fi
    fi
    
    log "‚úÖ V√©rifications de s√©curit√© OK"
}

deploy_binary() {
    log "üöÄ D√©ploiement du binaire..."
    
    local target_dir="${DEPLOY_DIR:-/opt/veza-chat}"
    local service_user="${SERVICE_USER:-veza-chat}"
    
    # Cr√©er l'utilisateur de service si n√©cessaire
    if ! id "$service_user" &>/dev/null; then
        info "Cr√©ation de l'utilisateur de service..."
        sudo useradd --system --home "$target_dir" --shell /bin/false "$service_user"
    fi
    
    # Cr√©er les r√©pertoires
    sudo mkdir -p "$target_dir"/{bin,config,logs}
    
    # Copier le binaire
    sudo cp "$PROJECT_ROOT/target/release/chat-server" "$target_dir/bin/"
    sudo chmod +x "$target_dir/bin/chat-server"
    
    # Copier la configuration
    if [[ -f "$PROJECT_ROOT/config/production.toml" ]]; then
        sudo cp "$PROJECT_ROOT/config/production.toml" "$target_dir/config/"
    fi
    
    # Permissions
    sudo chown -R "$service_user:$service_user" "$target_dir"
    
    log "‚úÖ Binaire d√©ploy√© dans $target_dir"
}

setup_systemd() {
    log "‚öôÔ∏è  Configuration du service systemd..."
    
    local service_file="/etc/systemd/system/veza-chat.service"
    local target_dir="${DEPLOY_DIR:-/opt/veza-chat}"
    local service_user="${SERVICE_USER:-veza-chat}"
    
    sudo tee "$service_file" > /dev/null << EOF
[Unit]
Description=Veza Chat Server
Documentation=https://github.com/veza/chat-server
After=network.target postgresql.service redis.service
Wants=postgresql.service redis.service

[Service]
Type=exec
User=$service_user
Group=$service_user
WorkingDirectory=$target_dir
ExecStart=$target_dir/bin/chat-server --config-file $target_dir/config/production.toml
ExecReload=/bin/kill -HUP \$MAINPID
Restart=always
RestartSec=5
TimeoutStopSec=30

# S√©curit√©
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=$target_dir/logs

# Variables d'environnement
Environment=RUST_LOG=info
EnvironmentFile=-$target_dir/.env

# Limits
LimitNOFILE=65536
LimitNPROC=32768

[Install]
WantedBy=multi-user.target
EOF

    sudo systemctl daemon-reload
    sudo systemctl enable veza-chat.service
    
    log "‚úÖ Service systemd configur√©"
}

setup_nginx() {
    log "üåê Configuration du proxy Nginx..."
    
    local nginx_config="/etc/nginx/sites-available/veza-chat"
    local domain="${DOMAIN:-localhost}"
    
    sudo tee "$nginx_config" > /dev/null << EOF
upstream veza_chat_backend {
    server 127.0.0.1:8080;
    keepalive 32;
}

server {
    listen 80;
    server_name $domain;
    
    # Redirection HTTPS en production
    return 301 https://\$server_name\$request_uri;
}

server {
    listen 443 ssl http2;
    server_name $domain;
    
    # Certificats SSL (√† configurer)
    # ssl_certificate /etc/letsencrypt/live/$domain/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/$domain/privkey.pem;
    
    # S√©curit√© SSL
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    ssl_prefer_server_ciphers off;
    ssl_dhparam /etc/nginx/dhparam.pem;
    
    # Headers de s√©curit√©
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload";
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header Referrer-Policy "strict-origin-when-cross-origin";
    
    # WebSocket
    location / {
        proxy_pass http://veza_chat_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # Health checks
    location /health {
        proxy_pass http://veza_chat_backend/health;
        access_log off;
    }
    
    # M√©triques (acc√®s restreint)
    location /metrics {
        proxy_pass http://veza_chat_backend/metrics;
        allow 127.0.0.1;
        allow 10.0.0.0/8;
        deny all;
    }
}
EOF

    sudo ln -sf "$nginx_config" /etc/nginx/sites-enabled/
    sudo nginx -t
    sudo systemctl reload nginx
    
    log "‚úÖ Nginx configur√©"
}

start_service() {
    log "‚ñ∂Ô∏è  D√©marrage du service..."
    
    sudo systemctl start veza-chat.service
    sleep 5
    
    # V√©rifier le statut
    if sudo systemctl is-active --quiet veza-chat.service; then
        log "‚úÖ Service d√©marr√© avec succ√®s"
        
        # Test de connectivit√©
        if curl -sf http://localhost:8080/health > /dev/null; then
            log "‚úÖ Health check OK"
        else
            warning "Health check √©chou√©"
        fi
    else
        error "√âchec du d√©marrage du service"
        sudo systemctl status veza-chat.service
        exit 1
    fi
}

show_status() {
    log "üìä √âtat du d√©ploiement:"
    
    echo
    info "Service Status:"
    sudo systemctl status veza-chat.service --no-pager -l
    
    echo
    info "Logs r√©cents:"
    sudo journalctl -u veza-chat.service --no-pager -l -n 10
    
    echo
    info "URLs d'acc√®s:"
    echo "  - WebSocket: ws://localhost:8080"
    echo "  - Health: http://localhost:8080/health"
    echo "  - Metrics: http://localhost:8080/metrics"
    
    if [[ -n "${DOMAIN:-}" ]]; then
        echo "  - Production: https://$DOMAIN"
    fi
}

# ================================================================
# FONCTION PRINCIPALE
# ================================================================

main() {
    local action="${1:-deploy}"
    
    echo
    log "üöÄ D√©ploiement Veza Chat Server v0.2.0"
    log "Action: $action"
    echo
    
    # Chargement de l'environnement
    if [[ -f "$PROJECT_ROOT/.env" ]]; then
        source "$PROJECT_ROOT/.env"
    fi
    
    case "$action" in
        "deploy")
            check_requirements
            create_backup
            build_application
            run_tests
            security_check
            setup_database
            deploy_binary
            setup_systemd
            start_service
            show_status
            ;;
        "update")
            log "üîÑ Mise √† jour de l'application..."
            create_backup
            build_application
            run_tests
            security_check
            sudo systemctl stop veza-chat.service
            deploy_binary
            setup_database
            sudo systemctl start veza-chat.service
            show_status
            ;;
        "status")
            show_status
            ;;
        "logs")
            sudo journalctl -u veza-chat.service -f
            ;;
        "restart")
            sudo systemctl restart veza-chat.service
            show_status
            ;;
        "stop")
            sudo systemctl stop veza-chat.service
            log "‚úÖ Service arr√™t√©"
            ;;
        *)
            echo "Usage: $0 {deploy|update|status|logs|restart|stop}"
            echo
            echo "  deploy  - D√©ploiement complet"
            echo "  update  - Mise √† jour de l'application"
            echo "  status  - Afficher le statut"
            echo "  logs    - Afficher les logs en temps r√©el"
            echo "  restart - Red√©marrer le service"
            echo "  stop    - Arr√™ter le service"
            exit 1
            ;;
    esac
    
    echo
    log "‚úÖ Action '$action' termin√©e avec succ√®s!"
}

# ================================================================
# EX√âCUTION
# ================================================================

main "$@" 